var Utility = utils;
$ = function (id) {
    return document.getElementById(id);
};

var host = "http://quote.eastmoney.com/hq2data/bk/data/", param;
var tuiguang = [

	'<a href="http://data.eastmoney.com/bkzj/dy.html" target="_blank">地域板块资金流今日排行</a>\
	<a href="http://data.eastmoney.com/bkzj/dy_5.html" target="_blank">地域板块资金流5日排行</a>\
	<a href="http://data.eastmoney.com/bkzj/dy_10.html" target="_blank">地域板块资金流10日排行</a>',

	'<a href="http://stock.eastmoney.com/hangye.html" target="_blank">行业频道</a>\
	<span id="hyzq"></span>\
	<a href="http://data.eastmoney.com/bkzj/hy.html" target="_blank">行业板块资金流今日排行</a>\
	<a href="http://data.eastmoney.com/bkzj/hy_5.html" target="_blank">行业板块资金流5日排行</a>\
	<a href="http://data.eastmoney.com/bkzj/hy_10.html" target="_blank">行业板块资金流10日排行</a>',

	'<a href="http://data.eastmoney.com/bkzj/gn.html" target="_blank">概念板块资金流今日排行</a>\
	<a href="http://data.eastmoney.com/bkzj/gn_5.html" target="_blank">概念板块资金流5日排行</a>\
	<a href="http://data.eastmoney.com/bkzj/gn_10.html" target="_blank">概念板块资金流10日排行</a>'
];

var typeKey, tpl, orderType,
	hashValues = { trade: 2, notion: 3, area: 1 },
    types = [
		,
		{ key: "BKDY", text: "地域", tuiguang: tuiguang[0] },
		{ key: "BKHY", text: "行业", tuiguang: tuiguang[1] },
		{ key: "BKGN", text: "概念", tuiguang: tuiguang[2] }
    ];

var Browser = {
    ie: /msie/.test(window.navigator.userAgent.toLowerCase()),
    moz: /gecko/.test(window.navigator.userAgent.toLowerCase()),
    opera: /opera/.test(window.navigator.userAgent.toLowerCase()),
    safari: /safari/.test(window.navigator.userAgent.toLowerCase()),
    Features: {
        XPath: !!document.evaluate
    }
};

//JsLoader
var JsLoader = {
    load: function (sUrl, sBianMa, fCallback) {
        var _script = document.createElement('script');
        _script.setAttribute('charset', sBianMa);
        _script.setAttribute('type', 'text/javascript');
        _script.setAttribute('src', sUrl);
        document.getElementsByTagName('head')[0].appendChild(_script);
        if (Browser.ie) {
            _script.onreadystatechange = function () {
                if (this.readyState == 'loaded' || this.readyState == 'complete') {
                    _script.parentNode.removeChild(_script);
                    fCallback();
                }
            };
        } else if (Browser.moz || Browser.opera) {
            _script.onload = function () {
                _script.parentNode.removeChild(_script);
                fCallback();
            };
        } else {
            _script.parentNode.removeChild(_script);
            fCallback();
        }
    }
};

function getHash(url) {
    var hash = url || location.hash;
    if (hash == "") { hash = "#trade_0_0?sortRule=0"; }
    var ret = hash.split("#");
    var val = ret[1].split("_")[0];
    var state = (val) ? val : "trade";
    return state;
}

function load(callback) {

    var orderType = Utility.getQueryString("sortRule");
    //替换老接口
    var url = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._" + typeKey + "&sty=FPGBKI&st=c&sr=-1&p=1&ps=5000&cb=&js=var%20BKCache=[(x)]&token=7bc05d0d4c3c22ef9fca8c2a912d779c";
    if (orderType > 0) {
        url = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._" + typeKey + "&sty=FPGBKI&st=c&sr=1&p=1&ps=5000&cb=&js=var%20BKCache=[(x)]&token=7bc05d0d4c3c22ef9fca8c2a912d779c";
    }
    JsLoader.load(url + "&v=" + Math.random(), "utf-8", function () {
        var dt = BKCache;
        $("listview").innerHTML = render(dt);
        if (callback) { callback(); }

    });

    //ajax.getScript(host + param, "gb2312", function() {
    //    var dt = BKCache[typeKey][orderType];
    //    $("listview").innerHTML = render(dt);
    //    if (callback) { callback(); }
    //});
}

function init(url) {
    var state = getHash(url);
    var typeIndex = hashValues[state],
        orderIndex = 1,
        orderTypeText;

    orderType = Utility.getQueryString("sortRule");
    typeKey = types[typeIndex].key;
    typeText = types[typeIndex].text;
    $("tuiguang").innerHTML = '<span class="btn-hot"></span>' + types[typeIndex].tuiguang;
    var topStockTd = "";

    if (orderType > 0) {
        orderType = 1;
        orderTypeText = "跌";
        $("current").innerHTML = typeText + "板块跌幅榜";
        topStockTd = '<td><a href="http://quote.eastmoney.com/{$data[12]|addMarket}.html" target="_blank">{$data[14]}</a></td>' +
            '<td><span class="{$css_3}">{$data[16]}%</span></td>';
    } else {
        orderType = 0;
        orderTypeText = "涨";
        $("current").innerHTML = typeText + "板块涨幅榜";
        topStockTd = '<td><a href="http://quote.eastmoney.com/{$data[7]|addMarket}.html" target="_blank">{$data[9]}</a></td>' +
            '<td><span class="{$css_2}">{$data[11]}%</span></td>';
    }
    var yanbao = '',
        zhuanqu = '',
        guba = '{$gubalinks} ';
    if (typeIndex === 2) {
        yanbao = ' <a href="http://data.eastmoney.com/report/{$code}yb.html" target="_blank">研报</a>';
        zhuanqu = '<a href="http://stock.eastmoney.com/hangye/hy{$code}.html" target="_blank">专区</a> ';
    }
    if (typeIndex === 1) {
        guba = '';
    }

    var header = '<table width="815" id="bklist" class="table-data">' +
        '<tr>' +
        '<th>排名</th>' +
        '<th>板块名称</th>' +
        '<th>相关资讯</th>' +
        '<th>最新价</th>' +
        '<th>涨跌额</th>' +
        '<th>涨跌幅</th>' +
        '<th>总市值(亿) </th>' +
        '<th>换手率</th>' +
        '<th width="70">上涨家数</th>' +
        '<th width="70">下跌家数</th>' +
        '<th>领' + orderTypeText + '股票 </th>' +
        '<th>涨跌幅</th>' +
        '</tr>';
    row = '<tr{$rowCss}>' +
            '<td>{$num}</td>' +
            '<td><a href="list.html#2800' + typeIndex + '{$code}_0_2" target="_blank">{$data[2]}</a></td>' +
            '<td><a href="http://quote.eastmoney.com/web/bk0{$code}1.html" target="_blank" style="color:#dc0000;margin-right:5px;">行情</a>' + zhuanqu + guba + '<a href="http://data.eastmoney.com/bkzj/{$code}.html" target="_blank">资金流</a>' + yanbao + '</td>' +
            '<td><span class="{$css}">{$data[18]}</span></td>' +
            '<td><span class="{$css}">{$data[19]}</span></td>' +
            '<td><span class="{$css}">{$data[3]}</span></td>' +
            '<td><span>{$totalMarketValue}</span></td>' +
            '<td><span>{$data[5]}%</span></td>' +
            '<td><span class="red">{$upCount}</span></td>' +
            '<td><span class="green">{$downCount}</span></td>' + topStockTd +
            '</tr>',
        footer = '</table>';
    tpl = new Repeater(header, row, footer);
    param = state + ".js?v=" + (+new Date());

    load(initcallback);
}

function initcallback() {
    var table = $("bklist");
    new FixedTableHeader(table);
}
function bkidpad(num, n) {
    y = '000' + num;
    return y.substr(y.length - n);
}

function render(dt) {
    var i = 0,
            n = dt.length,
            css, css_2, rowCss, upCount, downCount, code, totalMarketValue;

    for (; i < n; i++) {

        dataRow = String(dt[i]).split(",");
        css = quote.getCss(parseFloat(dataRow[3]));
        css_2 = quote.getCss(dataRow[11]);
        css_3 = quote.getCss(dataRow[16]);
        code = dataRow[1].replace("BK0", "");
        upCount = dataRow[6].split("|")[0];
        downCount = dataRow[6].split("|")[2];
        totalMarketValue = FixAmt(dataRow[4]).replace("亿", "");
        dataRow[3] = dataRow[3] == "-" ? "-" : dataRow[3] + "%";
        rowCss = i % 2 != 0 ? " class=\"bg\"" : "";
        tpl.set("rowCss", rowCss);
        tpl.set("data", dataRow);
        tpl.set("css", css);
        tpl.set("css_2", css_2);
        tpl.set("css_3", css_3);
        tpl.set("gubalinks", '<a href="http://guba.eastmoney.com/list,' + dataRow[1] + '.html" target="_blank">股吧</a>');
        tpl.set("num", i + 1);
        tpl.set("code", code);
        tpl.set("downCount", downCount);
        tpl.set("upCount", upCount);
        tpl.set("totalMarketValue", totalMarketValue);
        tpl.parse();
    }
    return tpl.toHTML();
}

function bkClick(e) {
    var href,
		target = DomEvent.getEventTarget();

    if (target.className === "text") {
        target = target.parentNode;
    }

    href = target.href;
    if (href && href.indexOf("BKList") > -1) {
        location.href = target.href;
        menu.setCurrent(target.href);
        init();
    }
}


init();
DomEvent.addEvent(treeMenu, "click", bkClick);
setInterval(function () {
    if (quote.HSOpening) {
        load();
    }

}, 1000 * 15);